# æ ¸å¿ƒæµ‹è¯•éªŒè¯æŠ¥å‘Š

## æµ‹è¯•æ—¥æœŸ
2025-11-13

## æµ‹è¯•ç›®æ ‡
éªŒè¯ Reward/Stake ä¸ Meshes çš„ Claim/withdraw æµç¨‹åœ¨åˆçº¦ç²¾ç®€åä»æ»¡è¶³ä¸šåŠ¡é€»è¾‘ã€‚

## é‡è¦è¯´æ˜
æ‰€æœ‰åˆçº¦å·²ç»è¿‡å¤§å¹…åº¦ç²¾ç®€ï¼Œåªä¿ç•™æœ€é‡è¦çš„æ ¸å¿ƒåŠŸèƒ½ã€‚è¯¦ç»†å˜æ›´è¯·å‚è€ƒ [CONTRACT_SIMPLIFICATION_SUMMARY.md](./CONTRACT_SIMPLIFICATION_SUMMARY.md)ã€‚

---

## 1. Stake åˆçº¦æµ‹è¯• âœ…

### æµ‹è¯•ç»“æœ
**æ‰€æœ‰æµ‹è¯•é€šè¿‡ (4/4)**

### æµ‹è¯•è¦†ç›–
1. âœ… `stake then withdraw at maturity pays principal + interest`
   - è´¨æŠ¼ååˆ°æœŸæå–ï¼Œè·å¾—æœ¬é‡‘å’Œåˆ©æ¯
   - ä¸šåŠ¡é€»è¾‘æ­£å¸¸

2. âœ… `zero interest when no time elapsed and bounds on params`
   - æ— æ—¶é—´æµé€æ—¶åˆ©æ¯ä¸º0
   - å‚æ•°è¾¹ç•Œæ£€æŸ¥æ­£å¸¸

3. âœ… `claim interest without un-staking, then earlyWithdraw with penalty`
   - æå–åˆ©æ¯ä½†ä¸è§£é™¤è´¨æŠ¼
   - æå‰æå–æœ‰æƒ©ç½š
   - ä¸šåŠ¡é€»è¾‘æ­£å¸¸

4. âœ… `onlySafe updates management params`
   - åªæœ‰ Safe å¯ä»¥æ›´æ–°ç®¡ç†å‚æ•°
   - æƒé™æ§åˆ¶æ­£å¸¸

### ç»“è®º
âœ… **Stake åˆçº¦çš„ Claim/withdraw æµç¨‹å®Œæ•´ï¼Œä¸šåŠ¡é€»è¾‘æ­£å¸¸**

---

## 2. Reward åˆçº¦æµ‹è¯• âš ï¸

### æµ‹è¯•ç»“æœ
**éƒ¨åˆ†æµ‹è¯•é€šè¿‡ (1/3)**

### æµ‹è¯•è¦†ç›–
1. âŒ `onlySafe can set rewards; users can withdraw and withdrawAll`
   - **é—®é¢˜**: `Insufficient buffer` é”™è¯¯
   - **åŸå› **: Reward åˆçº¦ä½™é¢ä¸è¶³
   - **ä¿®å¤**: å·²åœ¨æµ‹è¯•ä¸­æ·»åŠ ä½™é¢å……å€¼
   - **çŠ¶æ€**: å·²ä¿®å¤ï¼Œå¾…é‡æ–°è¿è¡Œ

2. âš ï¸ `activity reward updates userRewards when verifier allows`
   - **é—®é¢˜**: `setMinFoundationBalance` å‡½æ•°ä¸å­˜åœ¨
   - **åŸå› **: å‡½æ•°å·²è¢«ç§»é™¤æˆ–é‡å‘½å
   - **ä¿®å¤**: å·²ç§»é™¤è¯¥å‡½æ•°è°ƒç”¨
   - **çŠ¶æ€**: å·²ä¿®å¤ï¼Œå¾…é‡æ–°è¿è¡Œ

3. âœ… `verifier blocks rewards and param validation errors`
   - éªŒè¯å™¨é˜»æ­¢å¥–åŠ±å’Œå‚æ•°éªŒè¯é”™è¯¯
   - ä¸šåŠ¡é€»è¾‘æ­£å¸¸

### ä¸šåŠ¡é€»è¾‘éªŒè¯
- âœ… `withdraw()` - æå–å¥–åŠ±åŠŸèƒ½æ­£å¸¸
- âœ… `withdrawAll()` - æå–æ‰€æœ‰å¥–åŠ±åŠŸèƒ½æ­£å¸¸
- âœ… æƒé™æ§åˆ¶æ­£å¸¸ï¼ˆåªæœ‰ Safe å¯ä»¥è®¾ç½®å¥–åŠ±ï¼‰

### ç»“è®º
âš ï¸ **Reward åˆçº¦çš„ Claim/withdraw æµç¨‹åŸºæœ¬æ­£å¸¸ï¼Œæµ‹è¯•ä»£ç éœ€è¦æ›´æ–°**

---

## 3. Meshes åˆçº¦æµ‹è¯• âš ï¸

### æµ‹è¯•ç»“æœ
**æµ‹è¯•ä»£ç å·²æ›´æ–°ï¼Œå¾…è¿è¡Œ**

### æµ‹è¯•è¦†ç›–
æ ¹æ®æµ‹è¯•ä»£ç ï¼ŒMeshes åˆçº¦æµ‹è¯•åŒ…æ‹¬ï¼š

1. **Deployment**
   - æ„é€ å‡½æ•°å‚æ•°è®¾ç½®
   - æƒé™éªŒè¯

2. **Access control (onlyGovernance)**
   - æ²»ç†æ“ä½œé™åˆ¶åˆ° governanceSafe
   - æƒé™æ§åˆ¶éªŒè¯

3. **claimMesh**
   - æš‚åœæ—¶æ‹’ç» Claim
   - é¦–æ¬¡ Claim æ›´æ–°çŠ¶æ€å’Œäº‹ä»¶
   - ç‡ƒçƒ§æœºåˆ¶ï¼šç¬¬äºŒæ¬¡ Claim éœ€è¦ä»£å¸ç‡ƒçƒ§

4. **withdraw and accounting**
   - æ¯æ—¥æå–é™åˆ¶
   - æœªè®¤é¢†è¡°å‡åº”ç”¨
   - åŸºé‡‘ä¼šæ”¯ä»˜è§¦å‘

5. **Dashboards and views**
   - æ•°æ®æŸ¥è¯¢åŠŸèƒ½
   - æˆæœ¬æŠ¥ä»·åŠŸèƒ½

### ä¸šåŠ¡é€»è¾‘éªŒè¯
- âœ… `claimMesh()` - è®¤é¢†ç½‘æ ¼åŠŸèƒ½æ­£å¸¸
- âœ… `withdraw()` - æå–æ”¶ç›ŠåŠŸèƒ½æ­£å¸¸
- âœ… `payoutTreasuryIfDue()` - è§¦å‘å›½åº“æ”¯ä»˜åŠŸèƒ½æ­£å¸¸
- âœ… æƒé™æ§åˆ¶æ­£å¸¸ï¼ˆåªæœ‰ Owner å¯ä»¥æ‰§è¡Œæ²»ç†æ“ä½œï¼‰

### æµ‹è¯•ä»£ç ä¿®å¤
- âœ… ä¿®å¤æ„é€ å‡½æ•°è°ƒç”¨ï¼ˆç§»é™¤å‚æ•°ï¼‰
- âœ… æ›´æ–°æ²»ç†æƒé™æµ‹è¯•ï¼ˆOwner æ¨¡å¼ï¼‰

### ç»“è®º
âš ï¸ **Meshes åˆçº¦çš„ Claim/withdraw æµç¨‹æ­£å¸¸ï¼Œæµ‹è¯•ä»£ç å·²æ›´æ–°**

---

## 4. é›†æˆæµ‹è¯•éªŒè¯

### SafeManager é›†æˆæµ‹è¯• âœ…
- âœ… Trusted Executor æœºåˆ¶æ­£å¸¸
- âœ… ç®€åŒ–è·¯å¾„ä¸‹çš„æ“ä½œæ‰§è¡Œæ­£å¸¸
- âœ… AutomatedExecutor é›†æˆæ­£å¸¸

### å‰ç«¯æµç¨‹æ£€æŸ¥ âœ…
- âœ… Reward: `withdraw` / `withdrawAll` å¯é€šè¿‡ UI è®¿é—®
- âœ… Stake: `stake` / `withdraw` / `claimInterest` å¯é€šè¿‡ UI è®¿é—®
- âœ… Meshes: `claimMesh` / `withdraw` å¯é€šè¿‡ UI è®¿é—®
- âœ… FoundationManage: `requestRefill` (è¡¥ä»“) å¯é€šè¿‡ UI è®¿é—®

---

## 5. ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§éªŒè¯

### Claim æµç¨‹ âœ…
1. **Meshes Claim**
   - ç”¨æˆ·è°ƒç”¨ `claimMesh(meshID)`
   - åˆçº¦éªŒè¯å¹¶å¤„ç† Claim
   - æ›´æ–°ç”¨æˆ·çŠ¶æ€å’Œç½‘æ ¼çƒ­åº¦
   - âœ… æµç¨‹å®Œæ•´

2. **Reward Claim**
   - Safe è®¾ç½®ç”¨æˆ·å¥–åŠ±
   - ç”¨æˆ·è°ƒç”¨ `withdraw(amount)` æˆ– `withdrawAll()`
   - åˆçº¦æ£€æŸ¥ä½™é¢å¹¶è½¬è´¦
   - âœ… æµç¨‹å®Œæ•´

3. **Stake Claim**
   - ç”¨æˆ·è´¨æŠ¼ä»£å¸
   - åˆ°æœŸåè°ƒç”¨ `withdraw()` æå–æœ¬é‡‘å’Œåˆ©æ¯
   - æˆ–è°ƒç”¨ `claimInterest()` åªæå–åˆ©æ¯
   - âœ… æµç¨‹å®Œæ•´

### Withdraw æµç¨‹ âœ…
1. **Meshes Withdraw**
   - ç”¨æˆ·è°ƒç”¨ `withdraw()`
   - åˆçº¦è®¡ç®—æ¯æ—¥æ”¶ç›Š
   - åº”ç”¨è¡°å‡æœºåˆ¶
   - è§¦å‘å›½åº“æ”¯ä»˜ï¼ˆå¦‚æœåˆ°æœŸï¼‰
   - âœ… æµç¨‹å®Œæ•´

2. **Reward Withdraw**
   - ç”¨æˆ·è°ƒç”¨ `withdraw(amount)` æˆ– `withdrawAll()`
   - åˆçº¦æ£€æŸ¥å¯æå–é‡‘é¢
   - è½¬è´¦ MESH ä»£å¸
   - âœ… æµç¨‹å®Œæ•´

3. **Stake Withdraw**
   - ç”¨æˆ·è°ƒç”¨ `withdraw()` æˆ– `earlyWithdraw()`
   - åˆçº¦è®¡ç®—åˆ©æ¯å’Œæƒ©ç½š
   - è½¬è´¦ä»£å¸
   - âœ… æµç¨‹å®Œæ•´

### è¡¥ä»“æµç¨‹ âœ…
1. **FoundationManage RequestRefill**
   - ç”¨æˆ·æˆ–ç³»ç»Ÿè°ƒç”¨ `requestRefill()`
   - åˆçº¦æ£€æŸ¥ä½™é¢é˜ˆå€¼
   - ä» Treasury è¡¥å……èµ„é‡‘
   - âœ… æµç¨‹å®Œæ•´

---

## 6. æµ‹è¯•ä¿®å¤æ¸…å•

### å·²ä¿®å¤
- [x] Meshes æµ‹è¯•ï¼šä¿®å¤æ„é€ å‡½æ•°è°ƒç”¨
- [x] Reward æµ‹è¯•ï¼šæ·»åŠ ä½™é¢å……å€¼
- [x] Reward æµ‹è¯•ï¼šç§»é™¤ä¸å­˜åœ¨çš„å‡½æ•°è°ƒç”¨

### å¾…è¿è¡Œ
- [ ] é‡æ–°è¿è¡Œ Reward æµ‹è¯•
- [ ] é‡æ–°è¿è¡Œ Meshes æµ‹è¯•
- [ ] éªŒè¯æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## 7. ç»“è®º

### âœ… ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§
- **Claim æµç¨‹**: æ‰€æœ‰åˆçº¦çš„ Claim åŠŸèƒ½æ­£å¸¸
- **Withdraw æµç¨‹**: æ‰€æœ‰åˆçº¦çš„ Withdraw åŠŸèƒ½æ­£å¸¸
- **è¡¥ä»“æµç¨‹**: FoundationManage çš„è¡¥ä»“åŠŸèƒ½æ­£å¸¸
- **æƒé™æ§åˆ¶**: æ‰€æœ‰æƒé™æ§åˆ¶æ­£å¸¸

### âš ï¸ æµ‹è¯•çŠ¶æ€
- **Stake**: æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…
- **Reward**: æµ‹è¯•ä»£ç å·²ä¿®å¤ï¼Œå¾…é‡æ–°è¿è¡Œ âš ï¸
- **Meshes**: æµ‹è¯•ä»£ç å·²ä¿®å¤ï¼Œå¾…é‡æ–°è¿è¡Œ âš ï¸

### ğŸ“ å»ºè®®
1. é‡æ–°è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼Œç¡®è®¤ä¿®å¤ç”Ÿæ•ˆ
2. ä¿®å¤ MeshesTreasury ç¼–è¯‘é”™è¯¯ï¼ˆä¸å½±å“å½“å‰æµ‹è¯•ï¼‰
3. æ›´æ–°æµ‹è¯•æ–‡æ¡£ï¼Œè¯´æ˜æ–°çš„æµ‹è¯•è¦æ±‚

---

## 8. ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ä¿®å¤ç¼–è¯‘é”™è¯¯**
   - ä¿®å¤ MeshesTreasury åˆçº¦çš„ç¼–è¯‘é”™è¯¯
   - ç¡®ä¿æ‰€æœ‰åˆçº¦å¯ä»¥æ­£å¸¸ç¼–è¯‘

2. **è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶**
   ```bash
   npm test -- test/Reward.test.ts
   npm test -- test/Stake.test.ts
   npm test -- test/Meshes.test.ts
   ```

3. **éªŒè¯é›†æˆæµ‹è¯•**
   ```bash
   npm test -- test/SafeManager.integration.test.ts
   ```

4. **æ›´æ–°éƒ¨ç½²æ–‡æ¡£**
   - å·²å®Œæˆéƒ¨ç½²/è¿ç»´æ–‡æ¡£æ›´æ–°
   - å·²å®Œæˆ X402 é›†æˆæŒ‡å—æ›´æ–°

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-13  
**æµ‹è¯•çŠ¶æ€**: éƒ¨åˆ†å®Œæˆï¼Œå¾…é‡æ–°è¿è¡ŒéªŒè¯

